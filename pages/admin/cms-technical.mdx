# CMS Technical Documentation

## Overview

The Mind Measure CMS (Content Management System) is a comprehensive university administration platform built with React, TypeScript, and AWS serverless infrastructure. It enables university administrators to manage institutional data, emergency resources, content, and student wellbeing configurations.

**Deployment**: Vercel  
**URL**: `https://admin.mindmeasure.co.uk/university/{slug}/cms`  
**Authentication**: AWS Cognito  
**Database**: Aurora Serverless v2 (PostgreSQL)  
**Storage**: AWS S3

---

## Architecture

### Technology Stack

**Frontend:**
- React 18 with TypeScript
- Vite 6.x for build tooling
- Tailwind CSS for styling
- shadcn/ui component library
- Lucide React for icons
- React Router for routing

**Backend:**
- Aurora Serverless v2 (PostgreSQL 15.4)
- AWS Cognito for authentication
- AWS S3 for file storage
- Vercel Serverless Functions for API proxy

**Data Access:**
- `BackendServiceFactory` - Unified data access layer
- Direct PostgreSQL connections from Vercel API functions
- Application-level access control via Cognito JWT validation

---

## Project Structure

```
src/
├── components/
│   ├── institutional/
│   │   ├── UniversityCMS.tsx              # Main CMS interface
│   │   ├── UniversityScopedCMS.tsx        # University-scoped view
│   │   ├── UniversityDashboard.tsx        # Dashboard analytics
│   │   └── cms/
│   │       ├── UniversityOnboarding.tsx   # 7-step onboarding
│   │       ├── EmergencyResourcesManager.tsx
│   │       ├── ContentManager.tsx
│   │       ├── UniversityDataManager.tsx
│   │       └── data.ts                    # Data access functions
│   └── ui/                                 # shadcn/ui components
├── features/
│   └── cms/
│       └── data.ts                         # CMS data layer
├── services/
│   ├── database/
│   │   ├── BackendServiceFactory.ts       # Service factory
│   │   └── AWSService.ts                  # AWS implementation
│   └── auth-aws.ts                        # Cognito auth service
├── api/                                    # Vercel API functions
│   ├── auth/
│   │   └── signin.ts                      # Cognito sign-in proxy
│   └── database/
│       ├── select.ts                      # Database query proxy
│       ├── insert.ts
│       ├── update.ts
│       └── delete.ts
└── Router.tsx                              # Application routing
```

---

## Database Schema

The CMS uses Aurora Serverless v2 PostgreSQL with the following core tables:

### Core Tables

#### `universities`
Primary table storing all university information.

```sql
CREATE TABLE public.universities (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  short_name TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  website TEXT NOT NULL,
  contact_email TEXT NOT NULL,
  contact_phone TEXT,
  address TEXT,
  postcode TEXT,
  
  -- Student Demographics
  total_students INTEGER DEFAULT 0,
  undergraduate_students INTEGER DEFAULT 0,
  postgraduate_students INTEGER DEFAULT 0,
  international_students INTEGER DEFAULT 0,
  mature_students INTEGER DEFAULT 0,
  male_students INTEGER DEFAULT 0,
  female_students INTEGER DEFAULT 0,
  non_binary_students INTEGER DEFAULT 0,
  
  -- Branding
  primary_color TEXT DEFAULT '#0BA66D',
  secondary_color TEXT DEFAULT '#3b82f6',
  logo TEXT,
  logo_dark TEXT,
  campus_image TEXT,
  
  -- Status
  status TEXT DEFAULT 'planning',
  current_uptake_rate NUMERIC DEFAULT 0,
  
  -- Authentication (managed via Cognito)
  authorized_domains TEXT[] DEFAULT '{}',
  authorized_emails TEXT[] DEFAULT '{}',
  
  -- Emergency Resources (JSONB)
  emergency_contacts JSONB DEFAULT '[]',
  mental_health_services JSONB DEFAULT '[]',
  local_resources JSONB DEFAULT '[]',
  
  -- Metadata
  established INTEGER,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### `institutions`
Extended institutional management features.

```sql
CREATE TABLE public.institutions (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  domain TEXT,
  
  -- CMS Configuration
  local_help_resources JSONB DEFAULT '[]',
  branding JSONB DEFAULT '{}',
  settings JSONB DEFAULT '{}',
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### Content Management Tables

```sql
-- Content Categories
CREATE TABLE content_categories (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  university_id TEXT REFERENCES universities(id),
  name TEXT NOT NULL,
  slug TEXT NOT NULL,
  description TEXT,
  color TEXT DEFAULT '#3b82f6',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Content Articles
CREATE TABLE content_articles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  university_id TEXT REFERENCES universities(id),
  category_id UUID REFERENCES content_categories(id),
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  excerpt TEXT,
  status TEXT DEFAULT 'draft',
  author_email TEXT,
  published_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Content Tags
CREATE TABLE content_tags (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  university_id TEXT REFERENCES universities(id),
  name TEXT NOT NULL,
  slug TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  UNIQUE(university_id, slug)
);

-- Article-Tag Association
CREATE TABLE article_tags (
  article_id UUID REFERENCES content_articles(id) ON DELETE CASCADE,
  tag_id UUID REFERENCES content_tags(id) ON DELETE CASCADE,
  PRIMARY KEY (article_id, tag_id)
);
```

---

## Authentication & Authorisation

### AWS Cognito Integration

**User Pool**: `eu-west-2_ClAG4fQXR`  
**Client ID**: `7vu03ppv6alkpphs1ksopll8us`  
**Region**: `eu-west-2` (London)

#### Authentication Flow

```typescript
// Vercel API proxy to Cognito (api/auth/signin.ts)
import {
  CognitoIdentityProviderClient,
  InitiateAuthCommand
} from '@aws-sdk/client-cognito-identity-provider';

const client = new CognitoIdentityProviderClient({
  region: process.env.AWS_REGION,
  credentials: {
    accessKeyId: process.env.AWS_ACCESS_KEY_ID,
    secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY
  }
});

export default async function handler(req: VercelRequest, res: VercelResponse) {
  const { email, password } = req.body;
  
  const command = new InitiateAuthCommand({
    ClientId: process.env.AWS_COGNITO_CLIENT_ID,
    AuthFlow: 'USER_PASSWORD_AUTH',
    AuthParameters: {
      USERNAME: email,
      PASSWORD: password
    }
  });
  
  const result = await client.send(command);
  return res.json({ session: result.AuthenticationResult });
}
```

#### Client-Side Auth Service

```typescript
// src/services/auth-aws.ts
class AWSAuthService {
  async signIn(email: string, password: string) {
    // Call Vercel API proxy
    const authResult = await this.databaseService.auth.signIn({
      email,
      password
    });
    
    // Load profile from Aurora
    const { data: profiles } = await this.databaseService.select('profiles', {
      filters: { user_id: authResult.user.id },
      columns: '*'
    });
    
    return { user: authResult.user, profile: profiles[0] };
  }
}
```

### Access Control

**Application-Level Security:**
- All CMS access requires valid Cognito JWT token
- University-scoped data filtering via application logic
- No database-level RLS (Row Level Security)
- Authorisation checks in Vercel API functions

**University Access Rules:**
- Mind Measure staff (`@mindmeasure.co.uk`) → access all universities
- University administrators → access own university only
- Email domain validation against `authorized_domains`
- Email whitelist via `authorized_emails`

---

## Data Access Layer

### BackendServiceFactory

Unified data access abstraction supporting multiple backends.

```typescript
// src/services/database/BackendServiceFactory.ts
export class BackendServiceFactory {
  static createService(config: BackendConfig): DatabaseService {
    if (config.provider === 'aurora-serverless') {
      return new AWSService(config);
    }
    throw new Error(`Unsupported provider: ${config.provider}`);
  }
  
  static getEnvironmentConfig(): BackendConfig {
    return {
      provider: import.meta.env.VITE_BACKEND_PROVIDER || 'aurora-serverless',
      dbHost: import.meta.env.VITE_DB_HOST,
      dbPort: parseInt(import.meta.env.VITE_DB_PORT || '5432'),
      dbName: import.meta.env.VITE_DB_NAME,
      dbUser: import.meta.env.VITE_DB_USERNAME,
      dbPassword: import.meta.env.VITE_DB_PASSWORD,
      region: import.meta.env.VITE_AWS_REGION || 'eu-west-2'
    };
  }
}
```

### Database Operations

```typescript
// Features/CMS data access
import { BackendServiceFactory } from '@/services/database/BackendServiceFactory';

export async function getUniversityBySlug(slug: string): Promise<University | null> {
  const backendService = BackendServiceFactory.createService(
    BackendServiceFactory.getEnvironmentConfig()
  );
  
  const { data, error } = await backendService.select('universities', {
    filters: { slug },
    columns: '*'
  });
  
  if (error) throw error;
  return data?.[0] || null;
}

export async function updateUniversity(id: string, updates: Partial<University>) {
  const backendService = BackendServiceFactory.createService(
    BackendServiceFactory.getEnvironmentConfig()
  );
  
  const { error } = await backendService.update('universities', {
    filters: { id },
    updates
  });
  
  if (error) throw error;
}
```

### Vercel API Proxy Pattern

Database operations from the browser go through Vercel serverless functions:

```typescript
// api/database/select.ts
import { Pool } from 'pg';

const pool = new Pool({
  host: process.env.VITE_DB_HOST,
  port: parseInt(process.env.VITE_DB_PORT),
  database: process.env.VITE_DB_NAME,
  user: process.env.VITE_DB_USERNAME,
  password: process.env.VITE_DB_PASSWORD,
  ssl: { rejectUnauthorized: false }
});

export default async function handler(req: VercelRequest, res: VercelResponse) {
  const { table, filters, columns } = req.body;
  
  // Build and execute query
  const result = await pool.query(
    `SELECT ${columns} FROM ${table} WHERE ...`,
    [filterValues]
  );
  
  return res.json({ data: result.rows });
}
```

---

## Component Architecture

### Main CMS Interface

```typescript
// src/components/institutional/UniversityCMS.tsx
type CMSSection = 'dashboard' | 'onboarding' | 'emergency' | 'content' | 'data' | 'settings';

export function UniversityCMS({ institutionId }: UniversityCMSProps) {
  const [activeSection, setActiveSection] = useState<CMSSection>('dashboard');
  const [universities, setUniversities] = useState<University[]>([]);
  
  const loadData = async () => {
    const backendService = BackendServiceFactory.createService(
      BackendServiceFactory.getEnvironmentConfig()
    );
    
    const { data } = await backendService.select('universities', {
      filters: {},
      columns: '*'
    });
    
    setUniversities(data || []);
  };
  
  return (
    <Tabs value={activeSection} onValueChange={setActiveSection}>
      <TabsList>
        <TabsTrigger value="dashboard">Dashboard</TabsTrigger>
        <TabsTrigger value="onboarding">Profile</TabsTrigger>
        <TabsTrigger value="emergency">Emergency</TabsTrigger>
        <TabsTrigger value="content">Content</TabsTrigger>
        <TabsTrigger value="data">Data</TabsTrigger>
      </TabsList>
      
      <TabsContent value="dashboard">
        {/* Statistics and overview */}
      </TabsContent>
      
      <TabsContent value="onboarding">
        <UniversityOnboarding 
          universityId={selectedUniversityId}
          onSave={loadData}
        />
      </TabsContent>
      
      {/* Other sections */}
    </Tabs>
  );
}
```

### 7-Step Onboarding System

```typescript
// src/components/institutional/cms/UniversityOnboarding.tsx
const STEPS = [
  { number: 1, title: 'Basic Information', description: 'University details and contact' },
  { number: 2, title: 'Demographics', description: 'Student population data' },
  { number: 3, title: 'Academic Structure', description: 'Faculties, schools, departments' },
  { number: 4, title: 'Accommodation', description: 'Halls of residence' },
  { number: 5, title: 'Branding', description: 'Colors, logos, images' },
  { number: 6, title: 'Resources', description: 'Support services and contacts' },
  { number: 7, title: 'Review', description: 'Confirm and save' }
];

export function UniversityOnboarding({ universityId, onSave }: Props) {
  const [currentStep, setCurrentStep] = useState(1);
  const [formData, setFormData] = useState<UniversityFormData>({
    name: '',
    short_name: '',
    contact_email: '',
    // ... all fields with defaults
  });
  
  const handleSave = async () => {
    if (universityId) {
      await updateUniversity(universityId, formData);
    } else {
      await createUniversity(formData);
    }
    onSave?.();
  };
  
  return (
    <div>
      {/* Step indicator */}
      <div className="flex justify-between mb-8">
        {STEPS.map(step => (
          <StepIndicator 
            key={step.number}
            step={step}
            current={currentStep}
            completed={currentStep > step.number}
          />
        ))}
      </div>
      
      {/* Step content */}
      {currentStep === 1 && <BasicInformationForm data={formData} onChange={setFormData} />}
      {currentStep === 2 && <DemographicsForm data={formData} onChange={setFormData} />}
      {/* ... other steps */}
      
      {/* Navigation */}
      <div className="flex justify-between">
        <Button onClick={() => setCurrentStep(prev => prev - 1)}>Previous</Button>
        {currentStep < 7 ? (
          <Button onClick={() => setCurrentStep(prev => prev + 1)}>Next</Button>
        ) : (
          <Button onClick={handleSave}>Save University</Button>
        )}
      </div>
    </div>
  );
}
```

---

## Deployment

### Environment Variables

**Production** (`admin.mindmeasure.co.uk`)
```env
# Backend Provider
VITE_BACKEND_PROVIDER=aurora-serverless

# Aurora Database
VITE_DB_HOST=mindmeasure-aurora.cluster-cz8c8wq4k3ak.eu-west-2.rds.amazonaws.com
VITE_DB_PORT=5432
VITE_DB_NAME=mindmeasure
VITE_DB_USERNAME=mindmeasure_admin
VITE_DB_PASSWORD=[secure]

# AWS Cognito
VITE_AWS_COGNITO_USER_POOL_ID=eu-west-2_ClAG4fQXR
VITE_AWS_COGNITO_CLIENT_ID=7vu03ppv6alkpphs1ksopll8us
VITE_AWS_REGION=eu-west-2

# AWS S3 (for file uploads)
VITE_AWS_S3_BUCKET_NAME=mindmeasure-user-content-459338929203
```

**Vercel API Functions** (serverless)
```env
# Same as above, plus:
AWS_ACCESS_KEY_ID=[secure]
AWS_SECRET_ACCESS_KEY=[secure]
```

### Build & Deploy

```bash
# Local development
npm run dev

# Build for production
npm run build

# Deploy to Vercel
npx vercel --prod
```

### Vercel Configuration

```json
{
  "framework": "vite",
  "buildCommand": "npm run build",
  "outputDirectory": "dist",
  "installCommand": "npm install",
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "Content-Security-Policy",
          "value": "default-src 'self'; connect-src 'self' https://*.mindmeasure.co.uk https://*.amazonaws.com;"
        }
      ]
    }
  ]
}
```

---

## Development Workflow

### Local Development

```bash
# 1. Clone repository
git clone https://github.com/mindmeasure/mind-measure-core.git
cd mind-measure-core

# 2. Install dependencies
npm install

# 3. Set up environment variables
cp .env.example .env
# Edit .env with your Aurora and Cognito credentials

# 4. Start development server
npm run dev

# 5. Access CMS
# Navigate to http://localhost:5173/university/{slug}/cms
```

### Database Migrations

```bash
# Connect to Aurora
psql -h mindmeasure-aurora.cluster-cz8c8wq4k3ak.eu-west-2.rds.amazonaws.com \
     -U mindmeasure_admin \
     -d mindmeasure

# Run migration
\i migrations/add_cms_feature.sql
```

### Testing

```bash
# Run unit tests
npm test

# Run type checking
npm run type-check

# Run linter
npm run lint
```

---

## Monitoring & Debugging

### Vercel Logs

```bash
# View deployment logs
npx vercel logs admin.mindmeasure.co.uk

# View function logs
npx vercel logs admin.mindmeasure.co.uk --since=1h
```

### Database Monitoring

Access Aurora metrics via AWS Console:
- Query performance
- Connection count
- CPU/memory usage
- Storage metrics

### Error Handling

```typescript
// Global error boundary
class CMSErrorBoundary extends React.Component {
  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error('CMS Error:', error, errorInfo);
    
    // Log to monitoring service
    fetch('/api/log-error', {
      method: 'POST',
      body: JSON.stringify({ error: error.message, stack: errorInfo })
    });
  }
  
  render() {
    if (this.state.hasError) {
      return <ErrorFallback />;
    }
    return this.props.children;
  }
}
```

---

## Additional Resources

- [Architecture Documentation](/architecture)
- [Database Documentation](/database)
- [API Documentation](/api-documentation)
- [Deployment Guide](/deployment)
- [CMS User Guide](/cms-user-guide)

---

**Last Updated**: November 28, 2025  
**Version**: 3.0 (AWS Native)  
**Previous Version**: See `cms-technical-legacy-supabase.mdx` for historical Supabase implementation
