# Buddy System

The Buddy system enables students to nominate trusted friends or family members who can receive gentle email nudges to check in with them when wellbeing patterns indicate they may need support.

## Overview

The Buddy system provides:
- Email-only communication (V1 implementation)
- Consent-based invitation workflow
- Manual nudge reminders
- Full GDPR compliance
- No access to student wellbeing data for buddies

## Key Principles

1. **Privacy First** - Buddies never see wellbeing scores, check-ins, or app data
2. **Consent Required** - Buddies must explicitly accept before receiving any communication
3. **No Emergency Service** - This is NOT crisis intervention or monitoring
4. **Easy Opt-Out** - Buddies can decline or opt out at any time, no explanation needed
5. **Email Only (V1)** - No SMS, no in-app messaging, no phone calls

## Limitations

- Maximum 5 buddies per student (active + pending combined)
- 14-day invite expiry
- Rate limiting: Max 1 nudge per buddy per 14 days
- Single-use invitation tokens

## Key Features

### For Students

**Buddy Management**
- Add up to 5 support buddies via email
- View pending invitations and active buddies
- Send manual nudge reminders to active buddies
- Remove buddies at any time

**Invitation Flow**
- Enter buddy's name and email address
- Add optional personal message
- Buddy receives professionally designed HTML email
- Track invitation status (pending, accepted, declined, expired)

**Nudge Reminders**
- Send gentle check-in reminder to any active buddy
- Rate limited to prevent spam (14-day cooldown)
- Buddy receives email with opt-out option

### For Support Buddies

**Consent Workflow**
- Receive invitation email with student's full name
- Click "Review and respond" to view consent page
- Full information about what being a Buddy means
- Accept or decline with no explanation needed
- 14-day token expiry

**What Buddies See**
- Student's name only
- Generic "finding things harder than usual" message in nudges
- No wellbeing scores, check-ins, or activity data
- Opt-out link in every email

## Database Schema

### buddy_invites Table

Tracks all invitation attempts with status tracking.

```sql
CREATE TABLE buddy_invites (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,
  invitee_name VARCHAR(255) NOT NULL,
  contact_type VARCHAR(20) NOT NULL DEFAULT 'email',
  contact_value VARCHAR(255) NOT NULL,
  contact_value_masked VARCHAR(255),
  personal_message TEXT,
  status VARCHAR(20) NOT NULL DEFAULT 'pending'
    CHECK (status IN ('pending', 'accepted', 'declined', 'expired', 'revoked')),
  token_hash VARCHAR(255) NOT NULL,
  sent_at TIMESTAMP WITH TIME ZONE,
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
  resend_count INT NOT NULL DEFAULT 0,
  last_resend_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_buddy_invites_user_id ON buddy_invites(user_id);
CREATE INDEX idx_buddy_invites_status ON buddy_invites(user_id, status);
CREATE INDEX idx_buddy_invites_token_hash ON buddy_invites(token_hash);
```

### buddies Table

Created only when invite is accepted. Tracks active buddy relationships.

```sql
CREATE TABLE buddies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,
  invite_id UUID NOT NULL REFERENCES buddy_invites(id) ON DELETE RESTRICT,
  name VARCHAR(255) NOT NULL,
  email VARCHAR(255) NOT NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'active'
    CHECK (status IN ('active', 'removed')),
  preference_order INT NOT NULL DEFAULT 0,
  opt_out_slug VARCHAR(64) UNIQUE,
  last_nudged_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_buddies_user_id ON buddies(user_id);
CREATE INDEX idx_buddies_status ON buddies(user_id, status) WHERE status = 'active';
CREATE INDEX idx_buddies_opt_out_slug ON buddies(opt_out_slug);
```

## API Endpoints

Base URL: `https://mobile.mindmeasure.app/api/buddies`

### GET /api/buddies

List user's active buddies and pending invites.

**Auth:** Required (JWT)

**Response:**
```json
{
  "activeBuddies": [
    {
      "id": "uuid",
      "name": "Keith Simon",
      "email": "keith@example.com",
      "preferenceOrder": 1,
      "createdAt": "2026-01-15T10:00:00Z"
    }
  ],
  "pendingInvites": [
    {
      "id": "uuid",
      "inviteeName": "Sarah Jones",
      "contactType": "email",
      "contactValueMasked": "s***@example.com",
      "status": "pending",
      "sentAt": "2026-01-30T10:15:00Z",
      "expiresAt": "2026-02-13T10:15:00Z"
    }
  ]
}
```

### POST /api/buddies/invite

Create and send buddy invitation.

**Auth:** Required (JWT)

**Request:**
```json
{
  "inviteeName": "Keith Simon",
  "contactType": "email",
  "contactValue": "keith@example.com",
  "personalMessage": "Would love if you'd be my buddy!"
}
```

**Response:**
```json
{
  "invite": {
    "id": "uuid",
    "inviteeName": "Keith Simon",
    "contactType": "email",
    "contactValueMasked": "k***@example.com",
    "status": "pending",
    "sentAt": "2026-01-30T10:15:00Z",
    "expiresAt": "2026-02-13T10:15:00Z"
  }
}
```

**Features:**
- Generates 32-byte cryptographically secure token
- SHA-256 hash stored in database
- 14-day expiry
- Sends HTML email via AWS SES
- Uses student's full name (first + last)

### POST /api/buddies/invite/consent

Fetch invite data for consent page (public endpoint).

**Auth:** None required

**Request:**
```json
{
  "token": "abc123..."
}
```

**Response:**
```json
{
  "inviterName": "Keith Duddy",
  "inviteeName": "Keith Simon"
}
```

### POST /api/buddies/invite/respond

Accept or decline buddy invitation (public endpoint).

**Auth:** None required

**Request:**
```json
{
  "token": "abc123...",
  "action": "accept"
}
```

**Response:**
```json
{
  "ok": true,
  "action": "accepted"
}
```

**Process (Accept):**
1. Update invite status to `accepted`
2. Create `buddies` row with `status='active'`
3. Generate unique opt-out slug

**Process (Decline):**
1. Update invite status to `declined`

### POST /api/buddies/invite/:inviteId/resend

Resend invitation email.

**Auth:** Required (JWT)

**Rate Limit:** Max 1 resend per hour per invite

**Response:**
```json
{
  "ok": true,
  "message": "Invite resent"
}
```

### POST /api/buddies/invite/:inviteId/revoke

Cancel pending invitation.

**Auth:** Required (JWT)

**Response:**
```json
{
  "ok": true
}
```

### POST /api/buddies/:buddyId/nudge

Send check-in reminder to active buddy.

**Auth:** Required (JWT)

**Rate Limit:** Max 1 nudge per buddy per 14 days

**Response:**
```json
{
  "ok": true
}
```

### POST /api/buddies/:buddyId/remove

Remove buddy (soft delete).

**Auth:** Required (JWT)

**Response:**
```json
{
  "ok": true
}
```

## Email Templates

### Invite Email

**Subject:** `{Student Full Name} has invited you to be a Buddy`

**Content:**
- Greeting with buddy's name
- Explanation of what Mind Measure is
- What being a Buddy means
- Personal message from student (if provided)
- "Review and respond" CTA button
- Decline option with no explanation needed
- Footer explaining why they received the email

**Design:**
- Professional HTML template
- Purple gradient CTA button
- Personal message in styled box with purple accent
- Mobile-responsive layout

### Nudge Email

**Subject:** `A gentle check-in reminder for {Student Full Name}`

**Content:**
- Greeting with buddy's name
- Student "might be finding things harder than usual"
- Encouragement: "A quick message could help"
- Reassurance: "You don't need to fix anything"
- Yellow warning box: "This isn't an emergency alert"
- Opt-out link in footer

**Design:**
- Professional HTML template
- Yellow/amber warning box for emergency disclaimer
- Styled opt-out link

## Consent Page

**URL:** `https://mobile.mindmeasure.app/buddies/invite?token=xxx`

**States:**
1. **Loading** - Fetching invite data
2. **Consent** - Main decision page with full information
3. **Accepted** - Success confirmation with green checkmark
4. **Declined** - Decline confirmation
5. **Error** - Invalid/expired token handling

**Consent Page Content:**
- Mind Measure logo
- Purple gradient header: "You've been invited to be a Buddy"
- Subheading with student's full name
- Sections:
  - What Mind Measure is
  - What being a Buddy means
  - What this is not (3 bullet points)
  - When you might be contacted
  - Your data
- Footer links: Privacy policy, How Buddies work
- Action buttons: Accept (primary), Decline (secondary)
- Disclaimer: "No explanation needed"

## Privacy and GDPR Compliance

### Data Collection
- Buddy personal data: name, email only (no phone)
- Invite events: timestamps, status changes
- Nudge tracking: last_nudged_at timestamp

### Consent Mechanisms
1. Explicit consent via "Accept" button on consent page
2. Full disclosure of what being a Buddy means
3. Right to decline with no explanation
4. Opt-out link in every nudge email
5. 14-day token expiry

### User Rights (GDPR)
- Right to access data
- Right to erasure (opt-out removes buddy status)
- Right to withdraw consent at any time
- Right to data portability

### What Buddies Never See
- Wellbeing scores
- Check-in transcripts
- App activity
- Historical data
- Emergency alerts

## Rate Limiting

**Invite Sends:**
- Maximum 5 total buddies per student (active + pending)

**Invite Resends:**
- Maximum 1 resend per hour per invite

**Nudge Emails:**
- Maximum 1 nudge per buddy per 14 days
- Prevents spam and maintains trust

## Security Features

### Token Security
- 32-byte cryptographically secure random tokens
- SHA-256 hash stored in database (not plaintext)
- URL-safe base64url encoding
- 14-day expiry
- Single-use (marked as used after response)

### Data Protection
- Buddy emails masked in UI (k***@example.com)
- TLS encryption for all API calls
- Tokens never logged in plaintext
- Buddy emails not exposed to other users

### Email Security
- AWS SES with verified sender domain
- Reply-To: info@mindmeasure.co.uk
- From: no-reply@mindmeasure.co.uk
- Bounce and complaint handling configured

## Frontend Components

### BuddiesScreen
Main tab for buddy management. Lists active buddies and pending invites.

### AddBuddyModal
Form to invite new buddy with name, email, and optional personal message.

### BuddyCard
Displays active buddy with "Send reminder" and "Remove" actions.

### PendingInviteCard
Displays pending invitation with "Resend" and "Cancel" actions.

### BuddyReminderModal
Prompts new users to add their first buddy after completing their first check-in.

**Display Logic:**
- Show once only per user
- Show on first dashboard visit after completing 1+ check-in
- Don't show if user already has 1+ buddy
- Stored flag in Capacitor Preferences

### BuddyConsentPage
Public landing page for buddy invitation acceptance at `/buddies/invite?token=xxx`.

## User Flows

### Flow 1: Student Invites Buddy
1. Student opens Buddies tab
2. Taps "Add a Buddy"
3. Enters buddy name, email, optional message
4. API creates invite, sends email via SES
5. Invite appears as "Pending"

### Flow 2: Buddy Accepts
1. Buddy receives email
2. Clicks "Review and respond"
3. Lands on consent page
4. Reviews information, clicks "Accept"
5. Success page shown
6. Buddy created in database as active

### Flow 3: Buddy Declines
1. Buddy clicks "Decline" on consent page
2. Confirmation page shown
3. Invite marked as declined
4. No further emails sent

### Flow 4: Student Sends Nudge
1. Student views active buddy
2. Taps "Send reminder"
3. API validates rate limit (14 days)
4. Nudge email sent with student's full name
5. last_nudged_at updated

### Flow 5: Buddy Opts Out
1. Buddy clicks opt-out link in nudge email
2. Buddy status changed to "removed"
3. No further nudges sent

## Implementation Status

### Completed (V1)
- Database schema (buddy_invites + buddies tables)
- All API endpoints implemented
- AWS SES email integration (production access)
- HTML email templates (invite + nudge)
- Consent page with accept/decline
- Frontend components
- Buddy Reminder Modal
- Full name support in all emails
- Rate limiting
- GDPR-compliant consent flow

### Future (V2)
- Automated nudge triggers based on wellbeing patterns
- SMS support via AWS SNS
- University escalation for unresponsive buddies
- Analytics and engagement tracking

## Testing Checklist

- [ ] Student can add buddy with valid email
- [ ] Invitation email arrives with correct content
- [ ] Student's full name appears in email
- [ ] Personal message displays if provided
- [ ] Consent page loads with correct inviter name
- [ ] Accept button creates buddy in database
- [ ] Decline button marks invite as declined
- [ ] Expired token shows error message
- [ ] Student can resend invitation (respects rate limit)
- [ ] Student can revoke pending invite
- [ ] Student can send nudge to active buddy
- [ ] Nudge rate limit prevents spam (14 days)
- [ ] Student can remove buddy
- [ ] Buddy Reminder Modal appears after first check-in
- [ ] Max 5 buddies enforced
- [ ] Email deliverability (check spam folders)

## Related Documentation

- [Mobile App Overview](/mobile/overview)
- [Privacy and Legal](/security/privacy)
- [API Documentation](/api-reference/api-documentation)
- [AWS Authentication](/security/authentication-aws)

---

**Status:** V1 Complete - Email-only buddy system in production  
**Domain:** https://mobile.mindmeasure.app  
**Last Updated:** January 30, 2026
