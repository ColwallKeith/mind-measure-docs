# Database Documentation

This document provides comprehensive documentation for the Mind Measure Aurora Serverless v2 PostgreSQL database, including schemas, tables, relationships, indexes, and access patterns.

**Database**: Aurora Serverless v2 (PostgreSQL)  
**Host**: mindmeasure-aurora.cluster-cz8c8wq4k3ak.eu-west-2.rds.amazonaws.com  
**Schemas**: `public` (main app) and `assessment_engine` (multimodal assessment)

## Schema Overview

The MindMeasure database is designed around a multi-modal assessment system that tracks user wellness through various data points while maintaining strict privacy and security controls.

### Core Entities

```mermaid
erDiagram
    profiles ||--o{ assessment_sessions : creates
    assessment_sessions ||--o{ text_analysis : generates
    assessment_sessions ||--o{ audio_analysis : generates
    assessment_sessions ||--o{ visual_analysis : generates
    assessment_sessions ||--|| fusion_outputs : produces
    assessment_sessions ||--o{ session_insights : creates
    profiles ||--o{ user_baselines : establishes
    
    profiles {
        uuid id PK
        uuid user_id UK
        text display_name
        text first_name
        text last_name
        text avatar_url
        jsonb wellness_goals
        text assessment_frequency
        boolean onboarding_completed
        timestamp created_at
        timestamp updated_at
    }
    
    assessment_sessions {
        uuid id PK
        uuid user_id FK
        text status
        text category
        text assessment_type
        jsonb mood_before
        jsonb mood_after
        jsonb text_data
        jsonb audio_data
        jsonb visual_data
        text reflection_notes
        timestamp created_at
        timestamp updated_at
    }
```

---

## Database Connection

### From Vercel API Functions
```typescript
import { Pool } from 'pg';

const pool = new Pool({
  host: process.env.DB_HOST,
  port: parseInt(process.env.DB_PORT || '5432'),
  database: process.env.DB_NAME,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  ssl: { rejectUnauthorized: false }
});
```

### From AWS Lambda Functions
```typescript
import { Pool } from 'pg';

const pool = new Pool({
  host: process.env.DB_HOST,
  port: 5432,
  database: process.env.DB_NAME,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  ssl: { rejectUnauthorized: false }
});
```

### Access Control
- **Vercel API**: Uses database credentials from environment variables
- **Lambda Functions**: Use IAM-based authentication or connection credentials
- **Application-level**: User data access controlled by application logic (user_id filtering)

## Table Definitions

### profiles
**Purpose**: Stores user profile information and preferences

```sql
CREATE TABLE public.profiles (
    id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID NOT NULL UNIQUE,
    display_name TEXT,
    first_name TEXT,
    last_name TEXT,
    avatar_url TEXT,
    wellness_goals JSONB DEFAULT '[]'::jsonb,
    assessment_frequency TEXT DEFAULT 'weekly'::text,
    onboarding_completed BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
```

**Indexes**
```sql
CREATE UNIQUE INDEX idx_profiles_user_id ON profiles(user_id);
CREATE INDEX idx_profiles_created_at ON profiles(created_at);
```

**Triggers**
```sql
CREATE TRIGGER update_profiles_updated_at
    BEFORE UPDATE ON profiles
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

**Access Control**
- Application-level access control via user_id filtering
- All queries must include user_id check: `WHERE user_id = $1`
- No direct database access from client - all access via API

**JSON Schema - wellness_goals**
```typescript
interface WellnessGoals {
  goals: Array<{
    id: string;
    title: string;
    description?: string;
    category: 'sleep' | 'stress' | 'mood' | 'energy' | 'focus' | 'social';
    priority: 'low' | 'medium' | 'high';
    target_date?: string;
    completed: boolean;
    created_at: string;
  }>;
}
```

---

### assessment_sessions
**Purpose**: Central table for all assessment sessions and their metadata

```sql
CREATE TABLE public.assessment_sessions (
    id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID,
    status TEXT NOT NULL DEFAULT 'pending'::text,
    category TEXT DEFAULT 'general'::text,
    assessment_type TEXT DEFAULT 'full'::text,
    mood_before JSONB,
    mood_after JSONB,
    text_data JSONB,
    audio_data JSONB,
    visual_data JSONB,
    reflection_notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
```

**Indexes**
```sql
CREATE INDEX idx_sessions_user_id ON assessment_sessions(user_id);
CREATE INDEX idx_sessions_status ON assessment_sessions(status);
CREATE INDEX idx_sessions_user_date ON assessment_sessions(user_id, created_at DESC);
CREATE INDEX idx_sessions_type ON assessment_sessions(assessment_type);
```

**Check Constraints**
```sql
ALTER TABLE assessment_sessions 
ADD CONSTRAINT check_status_valid 
CHECK (status IN ('pending', 'processing', 'completed', 'failed'));

ALTER TABLE assessment_sessions 
ADD CONSTRAINT check_assessment_type_valid 
CHECK (assessment_type IN ('full', 'quick', 'voice-only'));
```

**Access Control**
- Application-level access control via user_id filtering
- Users can only access their own sessions via API endpoints

**JSON Schemas**

*mood_before/mood_after*
```typescript
interface MoodData {
  emotional_state: {
    primary: string;
    secondary?: string;
    intensity: number; // 1-10
  };
  energy_level: number; // 1-10
  stress_level: number; // 1-10
  sleep_quality?: number; // 1-10
  physical_comfort: number; // 1-10
  social_connection: number; // 1-10
  notes?: string;
  timestamp: string;
}
```

*text_data*
```typescript
interface TextData {
  transcripts?: string[];
  user_input?: string;
  conversation_data?: any[];
  processing_metadata?: {
    source: 'manual' | 'voice_transcript' | 'chat';
    quality_score?: number;
    language?: string;
  };
}
```

---

### text_analysis
**Purpose**: Stores AI analysis results for text-based assessment data

```sql
CREATE TABLE public.text_analysis (
    id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
    session_id UUID NOT NULL,
    combined_text TEXT,
    sentiment_analysis JSONB,
    cognitive_markers JSONB,
    linguistic_patterns JSONB,
    text_wellness_score NUMERIC,
    processed_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
```

**Indexes**
```sql
CREATE INDEX idx_text_analysis_session ON text_analysis(session_id);
CREATE INDEX idx_text_analysis_score ON text_analysis(text_wellness_score);
CREATE INDEX idx_text_analysis_processed ON text_analysis(processed_at);
```

**Access Control**
- Lambda functions create analysis records
- Users access via API with user_id validation

**JSON Schemas**

*sentiment_analysis*
```typescript
interface SentimentAnalysis {
  overall_sentiment: 'positive' | 'negative' | 'neutral';
  confidence: number;
  emotional_tone: string;
  mood_indicators: string[];
  sentiment_scores: {
    positive: number;
    negative: number;
    neutral: number;
  };
}
```

*cognitive_markers*
```typescript
interface CognitiveMarkers {
  clarity_score: number;
  coherence_score: number;
  thought_patterns: string[];
  cognitive_load: number;
  focus_indicators: string[];
  decision_making_patterns: string[];
}
```

---

### audio_analysis
**Purpose**: Stores analysis results from voice and audio processing

```sql
CREATE TABLE public.audio_analysis (
    id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
    session_id UUID NOT NULL,
    transcription TEXT,
    vocal_characteristics JSONB,
    prosodic_features JSONB,
    emotional_markers JSONB,
    audio_wellness_score NUMERIC,
    processed_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
```

**Indexes**
```sql
CREATE INDEX idx_audio_analysis_session ON audio_analysis(session_id);
CREATE INDEX idx_audio_analysis_score ON audio_analysis(audio_wellness_score);
```

**JSON Schemas**

*vocal_characteristics*
```typescript
interface VocalCharacteristics {
  pitch_mean: number;
  pitch_variance: number;
  speaking_rate: number;
  volume_mean: number;
  voice_quality: string;
  breath_patterns: {
    frequency: number;
    regularity: number;
  };
}
```

*prosodic_features*
```typescript
interface ProsodicFeatures {
  rhythm_stability: number;
  stress_patterns: string[];
  intonation_patterns: string[];
  pause_patterns: {
    frequency: number;
    duration_mean: number;
    placement: string[];
  };
}
```

---

### visual_analysis
**Purpose**: Stores analysis results from visual/facial expression processing

```sql
CREATE TABLE public.visual_analysis (
    id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
    session_id UUID NOT NULL,
    facial_expressions JSONB,
    micro_expressions JSONB,
    emotional_indicators JSONB,
    visual_wellness_score NUMERIC,
    processed_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
```

**JSON Schemas**

*facial_expressions*
```typescript
interface FacialExpressions {
  primary_emotions: Array<{
    emotion: string;
    confidence: number;
    duration: number;
  }>;
  expression_changes: Array<{
    timestamp: number;
    from_emotion: string;
    to_emotion: string;
  }>;
  overall_expressiveness: number;
}
```

---

### fusion_outputs
**Purpose**: Comprehensive wellness scores using fusion model with probabilities

```sql
CREATE TABLE public.fusion_outputs (
    session_id UUID NOT NULL PRIMARY KEY,
    user_id UUID NOT NULL,
    p_worse_fused DOUBLE PRECISION NOT NULL,
    p_worse_audio DOUBLE PRECISION,
    p_worse_visual DOUBLE PRECISION, 
    p_worse_text DOUBLE PRECISION,
    p_worse_passive DOUBLE PRECISION,
    score INTEGER NOT NULL,
    score_smoothed DOUBLE PRECISION NOT NULL,
    uncertainty DOUBLE PRECISION NOT NULL,
    qc_overall TEXT NOT NULL DEFAULT 'reliable',
    drivers JSONB,
    model_version TEXT NOT NULL DEFAULT 'v1.0',
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
```

**Indexes**
```sql
CREATE INDEX idx_scores_session ON mind_measure_scores(session_id);
CREATE INDEX idx_scores_combined ON mind_measure_scores(combined_score);
CREATE INDEX idx_scores_calculated ON mind_measure_scores(calculated_at);
CREATE INDEX idx_scores_baseline ON mind_measure_scores(is_baseline_session, calculated_at);
```

**JSON Schemas**

*baseline_comparison*
```typescript
interface BaselineComparison {
  deviation: number;
  significance: 'low' | 'medium' | 'high';
  trend: 'improving' | 'stable' | 'declining';
  confidence_level: number;
  comparison_period: {
    start_date: string;
    end_date: string;
    session_count: number;
  };
}
```

*trend_analysis*
```typescript
interface TrendAnalysis {
  short_term: string; // Last 7 days
  medium_term: string; // Last 30 days
  long_term: string; // Last 90 days
  patterns: string[];
  correlations: Array<{
    factor: string;
    correlation: number;
    confidence: number;
  }>;
}
```

---

### session_insights
**Purpose**: AI-generated insights and recommendations from assessment sessions

```sql
CREATE TABLE public.session_insights (
    id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
    session_id UUID NOT NULL,
    key_concerns JSONB DEFAULT '[]'::jsonb,
    emotional_themes JSONB DEFAULT '{}'::jsonb,
    conversation_summary TEXT,
    notable_changes TEXT,
    follow_up_topics JSONB DEFAULT '[]'::jsonb,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
```

**JSON Schemas**

*key_concerns*
```typescript
interface KeyConcerns {
  concerns: Array<{
    concern: string;
    category: string;
    severity: 'low' | 'medium' | 'high';
    mentioned_count: number;
    first_mentioned: string;
    context: string;
  }>;
}
```

*emotional_themes*
```typescript
interface EmotionalThemes {
  themes: {
    [theme: string]: {
      frequency: number;
      intensity: number;
      context: string[];
      trend: 'increasing' | 'stable' | 'decreasing';
    };
  };
}
```

---

### user_baselines
**Purpose**: Personal wellness baselines for each user across different metrics

```sql
CREATE TABLE public.user_baselines (
    id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID NOT NULL,
    metric_type TEXT NOT NULL,
    baseline_score NUMERIC NOT NULL,
    confidence_level NUMERIC NOT NULL DEFAULT 0.5,
    sample_count INTEGER NOT NULL DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
    last_updated TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
```

**Indexes**
```sql
CREATE UNIQUE INDEX idx_baselines_user_metric ON user_baselines(user_id, metric_type);
CREATE INDEX idx_baselines_updated ON user_baselines(last_updated);
```

**Metric Types**
- `combined_wellness`: Overall wellness score
- `audio_wellness`: Voice-based wellness indicators
- `text_wellness`: Text-based wellness indicators
- `visual_wellness`: Visual-based wellness indicators
- `mood_stability`: Emotional stability tracking
- `stress_levels`: Stress pattern baselines

---

## Database Functions

### update_updated_at_column()
**Purpose**: Automatically updates the `updated_at` timestamp on record modification

```sql
CREATE OR REPLACE FUNCTION public.update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### create_user_profile()
**Purpose**: Creates a profile for a new user (called from application code)

```typescript
// Called from Vercel API or Lambda after Cognito user creation
async function createUserProfile(userId: string, email: string, metadata?: any) {
  await pool.query(
    `INSERT INTO public.profiles (user_id, display_name, first_name, last_name)
     VALUES ($1, $2, $3, $4)`,
    [
      userId,
      metadata?.display_name || email,
      metadata?.first_name || null,
      metadata?.last_name || null
    ]
  );
}
```
```

---

## Database Triggers

### Profile Triggers
```sql
-- Auto-update timestamp on profile changes
CREATE TRIGGER update_profiles_updated_at
    BEFORE UPDATE ON profiles
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Profile creation handled by application code after Cognito user creation
-- No database trigger needed - called from API endpoint
```

### Session Triggers
```sql
-- Auto-update timestamp on session changes
CREATE TRIGGER update_sessions_updated_at
    BEFORE UPDATE ON assessment_sessions
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

---

## Assessment Engine Schema

The `assessment_engine` schema contains tables for the multimodal assessment pipeline (deployed November 28, 2025).

### Schema Overview

**Tables:**
- `check_ins` - Main check-in records
- `audio_analysis` - 23 audio features per check-in
- `visual_analysis` - 18 visual features per check-in  
- `text_analysis` - 16 text features per check-in
- `fusion_results` - Final Mind Measure scores (0-100)
- `user_baselines` - Personal baseline data for z-score normalization

**Connection:**
```typescript
// From Lambda functions
import { Pool } from 'pg';

const pool = new Pool({
  host: process.env.DB_HOST,
  database: process.env.DB_NAME,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD
});

// Query Assessment Engine tables
const result = await pool.query(
  'SELECT * FROM assessment_engine.fusion_results WHERE user_id = $1',
  [userId]
);
```

**Full Schema Documentation:**
See `/assessment-engine/migrations/checkin-pipeline-v2.sql` for complete schema definition.

---

## Security & Privacy

### Access Control

**Application-Level Security:**
- All database access goes through API endpoints (Vercel serverless functions or Lambda)
- User authentication via AWS Cognito (JWT tokens)
- Application logic enforces user_id filtering on all queries
- No direct database access from client applications

**Database-Level Security:**
- Aurora Serverless v2 with encryption at rest
- TLS 1.3 for all connections
- IAM-based authentication for Lambda functions
- Connection credentials stored in environment variables (not in code)

### Data Encryption

**At Rest**
- PostgreSQL transparent data encryption
- Sensitive JSONB fields use application-level encryption
- Backup encryption with rotating keys

**In Transit**
- TLS 1.3 for all database connections
- Certificate pinning for additional security
- Connection pooling with encrypted channels

### Data Retention

**Automated Policies**
```sql
-- Example: Archive old sessions after 2 years
CREATE OR REPLACE FUNCTION archive_old_sessions()
RETURNS void AS $$
BEGIN
    -- Move to archive table
    INSERT INTO assessment_sessions_archive 
    SELECT * FROM assessment_sessions 
    WHERE created_at < NOW() - INTERVAL '2 years';
    
    -- Delete from main table
    DELETE FROM assessment_sessions 
    WHERE created_at < NOW() - INTERVAL '2 years';
END;
$$ LANGUAGE plpgsql;
```

---

## Performance Optimisation

### Indexing Strategy

**Primary Indexes**
- All foreign keys are indexed
- Date fields for temporal queries
- Score fields for analysis queries
- Composite indexes for common query patterns

**Query Optimisation**
```sql
-- Optimized query for user dashboard
EXPLAIN (ANALYZE, BUFFERS) 
SELECT s.*, ms.combined_score, ms.baseline_deviation
FROM assessment_sessions s
LEFT JOIN mind_measure_scores ms ON s.id = ms.session_id
WHERE s.user_id = $1 
ORDER BY s.created_at DESC 
LIMIT 10;
```

### Partitioning

**Time-based Partitioning** for large tables
```sql
-- Partition assessment_sessions by month
CREATE TABLE assessment_sessions_y2024m01 PARTITION OF assessment_sessions
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
```

---

## Backup & Recovery

### Backup Strategy
- **Point-in-time recovery**: 7-day retention
- **Daily full backups**: 30-day retention
- **Weekly archive backups**: 1-year retention
- **Annual compliance backups**: 7-year retention

### Recovery Procedures
```sql
-- Example: Restore specific user data
BEGIN;
-- Restore from backup timestamp
SELECT * FROM backup_restore_user_data('user_uuid', '2024-01-01 12:00:00');
COMMIT;
```

---

## Migration Guidelines

### Schema Changes
- Always use migrations for schema changes
- Test migrations on staging data
- Plan for zero-downtime deployments
- Document breaking changes

### Version Control
```sql
-- Migration versioning example
-- V001__initial_schema.sql
-- V002__add_user_baselines.sql
-- V003__enhance_analysis_tables.sql
```

This database schema supports the comprehensive mental wellness assessment platform while maintaining strict security, privacy, and performance standards.