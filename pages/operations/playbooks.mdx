# Playbooks

Operational procedures and common tasks for managing the Mind Measure Core platform.

## User Management

### Onboard a University

1. **Create Institution Record**
   ```sql
   INSERT INTO institutions (name, slug) 
   VALUES ('University Name', 'university-slug');
   ```

2. **Configure Allowed Domains**
   ```sql
   INSERT INTO allowed_domains (institution_id, domain) 
   VALUES (institution_id, 'university.edu');
   ```

3. **Set Up Admin User**
   ```sql
   INSERT INTO memberships (user_id, institution_id, role) 
   VALUES (admin_user_id, institution_id, 'admin');
   ```

4. **Configure Institution Settings**
   - Upload institution branding
   - Set up mental health resources
   - Configure assessment parameters
   - Set up notification preferences

### Promote a User to Admin

1. **Verify User Identity**
   ```sql
   -- Query Cognito user via AWS CLI or application code
   -- Or check profiles table:
   SELECT id, user_id, display_name FROM profiles 
   WHERE display_name LIKE '%user@university.edu%';
   ```

2. **Update Membership Role**
   ```sql
   UPDATE memberships 
   SET role = 'admin' 
   WHERE user_id = user_id AND institution_id = institution_id;
   ```

3. **Grant Additional Permissions**
   - Access to user management
   - Resource management capabilities
   - Reporting and analytics access
   - System configuration rights

4. **Notify User**
   - Send email confirmation
   - Provide admin dashboard access
   - Share admin documentation
   - Schedule training if needed

### Promote a User to Superadmin

1. **Verify Superuser Authority**
   - Confirm authorisation from system administrator
   - Document promotion reason
   - Update audit logs

2. **Execute Promotion Function**
   ```sql
   SELECT make_superuser_by_email('admin@mindmeasure.co.uk');
   ```

3. **Verify Permissions**
   ```sql
   SELECT * FROM memberships WHERE user_id = user_id AND role = 'superadmin';
   ```

4. **Update Documentation**
   - Record in admin user list
   - Update contact information
   - Notify other superadmins

## System Administration

### Rotate Keys

1. **Generate New Keys**
   ```bash
   # Generate new JWT secret (if using custom JWT)
   openssl rand -base64 32
   
   # Rotate Aurora database password
   aws rds modify-db-cluster \
     --db-cluster-identifier mindmeasure-aurora \
     --master-user-password "new-secure-password" \
     --apply-immediately \
     --region eu-west-2
   ```

2. **Update Environment Variables**
   ```bash
   # Update Aurora credentials in AWS Secrets Manager
   aws secretsmanager update-secret \
     --secret-id aurora-credentials \
     --secret-string '{"username":"mindmeasure_admin","password":"new-password"}' \
     --region eu-west-2
   
   # Update Vercel environment variables
   vercel env add DB_PASSWORD production
   ```

3. **Restart Services**
   ```bash
   # Lambda functions auto-update on next invocation
   # Vercel functions restart automatically
   # Aurora connection pool refreshes automatically
   
   # Force Lambda refresh (if needed)
   aws lambda update-function-configuration \
     --function-name CheckInStartLambda \
     --environment Variables={DB_PASSWORD=new-password} \
     --region eu-west-2
   ```

4. **Verify Functionality**
   - Test authentication
   - Verify API access
   - Check admin dashboard
   - Monitor error logs

### Database Maintenance

1. **Run Database Vacuum**
   ```sql
   VACUUM ANALYZE;
   ```

2. **Check Index Usage**
   ```sql
   SELECT schemaname, tablename, attname, n_distinct, correlation
   FROM pg_stats
   WHERE schemaname = 'public'
   ORDER BY tablename, attname;
   ```

3. **Monitor Query Performance**
   ```sql
   SELECT query, calls, total_time, mean_time
   FROM pg_stat_statements
   ORDER BY total_time DESC
   LIMIT 10;
   ```

4. **Update Statistics**
   ```sql
   ANALYZE;
   ```

### Backup and Recovery

1. **Create Manual Backup**
   ```bash
   # Create database dump
   pg_dump -h db_host -U postgres -d mind_measure > backup_$(date +%Y%m%d).sql
   ```

2. **Verify Backup Integrity**
   ```bash
   # Test backup restoration
   psql -h test_host -U postgres -d test_db < backup_file.sql
   ```

3. **Test Recovery Procedure**
   - Simulate data loss scenario
   - Restore from backup
   - Verify data integrity
   - Update recovery documentation

## Security Operations

### Incident Response

1. **Initial Assessment**
   - Identify security incident type
   - Assess potential impact
   - Document initial findings
   - Notify relevant stakeholders

2. **Containment**
   - Isolate affected systems
   - Preserve evidence
   - Prevent further damage
   - Implement temporary fixes

3. **Investigation**
   - Analyze logs and data
   - Identify attack vectors
   - Determine scope of compromise
   - Document findings

4. **Recovery**
   - Restore systems from clean backups
   - Implement security patches
   - Update security configurations
   - Monitor for recurring issues

5. **Post-Incident**
   - Conduct lessons learned review
   - Update security procedures
   - Implement additional safeguards
   - Report to relevant authorities

### Access Review

1. **User Access Audit**
   ```sql
   -- Query profiles and memberships
   SELECT p.display_name, p.user_id, m.role, i.name as institution
   FROM profiles p
   JOIN memberships m ON p.user_id = m.user_id
   JOIN institutions i ON m.institution_id = i.id
   ORDER BY i.name, m.role;
   
   -- Or via AWS Cognito (using AWS CLI)
   aws cognito-idp list-users \
     --user-pool-id eu-west-2_ClAG4fQXR \
     --region eu-west-2
   ```

2. **Permission Validation**
   - Review user roles and permissions
   - Verify access appropriateness
   - Document access decisions
   - Update access controls

3. **Clean Up**
   - Remove inactive users
   - Revoke unnecessary permissions
   - Update role assignments
   - Document changes

## Monitoring and Alerting

### Health Checks

1. **Database Health**
   ```sql
   SELECT 
     pg_database_size('mind_measure') as db_size,
     (SELECT count(*) FROM pg_stat_activity) as active_connections,
     (SELECT count(*) FROM pg_stat_activity WHERE state = 'active') as active_queries;
   ```

2. **Application Health**
   - Check API response times
   - Monitor error rates
   - Verify authentication flows
   - Test critical user journeys

3. **Infrastructure Health**
   - Server resource utilization
   - Network connectivity
   - Storage capacity
   - Backup status

### Alert Configuration

1. **Critical Alerts**
   - Database connection failures
   - Authentication system down
   - High error rates
   - Security incidents

2. **Warning Alerts**
   - High resource utilization
   - Slow query performance
   - Backup failures
   - Unusual access patterns

3. **Info Alerts**
   - Successful deployments
   - Scheduled maintenance
   - User activity summaries
   - System updates

## Deployment Procedures

### Production Deployment

1. **Pre-Deployment**
   - Run full test suite
   - Verify staging environment
   - Review change documentation
   - Notify stakeholders

2. **Deployment**
   - Deploy to production
   - Monitor deployment logs
   - Verify functionality
   - Check error rates

3. **Post-Deployment**
   - Monitor system health
   - Verify user functionality
   - Check performance metrics
   - Document any issues

### Rollback Procedures

1. **Identify Rollback Need**
   - Monitor error rates
   - Check user reports
   - Review system logs
   - Assess impact

2. **Execute Rollback**
   - Revert to previous version
   - Restore database if needed
   - Verify system stability
   - Notify users if necessary

3. **Post-Rollback**
   - Investigate root cause
   - Plan fix for next deployment
   - Update procedures
   - Document lessons learned

## Compliance and Auditing

### Data Privacy Compliance

1. **GDPR Compliance**
   - Data subject access requests
   - Right to deletion
   - Data portability
   - Consent management

2. **HIPAA Compliance**
   - Protected health information handling
   - Access controls
   - Audit trails
   - Breach notification

3. **Institutional Privacy**
   - Student data protection
   - FERPA compliance
   - Institutional policies
   - Data retention policies

### Audit Procedures

1. **Regular Audits**
   - User access reviews
   - Data usage audits
   - Security configuration reviews
   - Compliance assessments

2. **Audit Documentation**
   - Audit findings
   - Remediation plans
   - Compliance status
   - Improvement recommendations

3. **Audit Follow-up**
   - Implement recommendations
   - Monitor compliance
   - Update procedures
   - Schedule next audit